---
title: Two-Way-ANOVA with and without interaction vs. individual t-tests
date: 2023-08-28
categories:
  - R
execute:
  cache: true
---

## Introduction
...
```{r}
#| label: init
#| message: false
library('tidyverse')
library('multcomp')
library('knitr')
set.seed(2)
```

## Simulation model
* Normally distributed data
* Two-way ANOVA design
  * Factor `F1` with levels `A` and `B`
  * Factor `F2` with levels `A` and `B`
* Means:
  * `F1` = `A`, `F2` = `A` &rarr; $\mu = 0$
  * `F1` = `A`, `F2` = `B` &rarr; $\mu = 1$
  * `F1` = `B`, `F2` = `A` &rarr; $\mu = 1$
  * `F1` = `B`, `F2` = `B` &rarr; $\mu = 3$
* Standard deviation of error:
  * $\sigma = 1$
* In treatment coding, this corresponds to the coefficient vector $\beta = (0, 1, 1, 1)^T$
* 10 individuals per group

  
## Example of simulated data
```{r}
generate_data <- function(n = 10, beta = c(0, 1, 1, 1)) {
  dd <- expand_grid(id = 1:n, F1 = c('A', 'B'), F2 = c('A', 'B'))
  X <- model.matrix(~ F1 * F2, data = dd)
  dd |> mutate(y = (X %*% beta)[, 1] + rnorm(nrow(dd)))
}

generate_data() |> 
  mutate(x = 0) |> 
  ggplot(aes(x, y)) + 
  geom_boxplot() + geom_jitter(width = 0.1, height = 0) +
  facet_wrap(vars(F1, F2), labeller = label_both, ncol = 4) +
  labs(x = '(Points are jittered along x-axis)') +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) 
```

## Simulate many datasets in order to estimate power to test the hypotheses
* For ANOVA analysis the multcomp package is used in order to simultaneously test the hypotheses (correction for multiple testing with respect to the three hypotheses is included by design)
* Calculate p-values testing the main effects ($\beta_1 = 0$ and $\beta_2 = 0$) and the interaction ($\beta_3 = 0$) for each of the simulations
* Estimate power empirically

```{r}
simulate_two_way_ANOVA <- function(include_interaction = FALSE) {
  if(include_interaction) {
    fm <- lm(y ~ F1 * F2, data = generate_data())
    ii <- -1
  } else {
    fm <- lm(y ~ F1 + F2, data = generate_data(), subset = (F1 == 'A' | F2 == 'A'))
    ii <- c(-1, -4)
  }
  p_values <- summary(glht(fm, linfct = paste(names(coef(fm))[ii], '= 0')))$test$pvalues
  attributes(p_values) <- NULL
  return(p_values)
}
```

### Power of ANOVA analysis without interaction
```{r}
nr_of_sims <- 5e4
tibble(Effect = c('Main effect 1', 'Main effect 2'),
       Power = rowSums(replicate(n = nr_of_sims, simulate_two_way_ANOVA()) < 
                         0.05) / nr_of_sims) |> 
  kable(align = 'c', digits = 3)
```

### Power of ANOVA analysis with interaction
```{r}
nr_of_sims <- 5e4
tibble(Effect = c('Main effect 1', 'Main effect 2', 'Interaction'),
       Power = rowSums(replicate(n = nr_of_sims, 
                                 simulate_two_way_ANOVA(include_interaction = TRUE)) < 
                         0.05) / nr_of_sims) |> 
  kable(align = 'c', digits = 3)
```

### Power of separate t-tests
```{r}
# Bonferroni correction for two tests:
power.t.test(n = 10, delta = 1, sd = 1, sig.level = 0.05 / 2)
# Bonferroni correction for three tests:
power.t.test(n = 10, delta = 1, sd = 1, sig.level = 0.05 / 3)
```

## Conclusion
* Power in Two-Way-ANOVA without interaction is slightly greater than power of two separate t-tests corrected with Bonferroni procedure (30 individuals needed in both cases, provided that the control group is 'recycled' in the t-test case)
* Power in Two-Way-ANOVA with interaction is approximately equal to power of two separate t-tests corrected with Bonferroni procedure (10 additional individuals needed in order to test interaction)
* Power could be improved without increased total sample size by appropriately increasing the size of the control group
